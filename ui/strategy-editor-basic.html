<!doctype html>
<html lang="zh-CN" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IBX Console - 基本信息编辑</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg border-bottom sticky-top navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand fw-semibold" href="./index.html">IBX Console</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav" aria-controls="topNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="topNav">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="./strategies.html">策略列表</a></li>
            <li class="nav-item"><a class="nav-link" href="./events.html">运行事件</a></li>
            <li class="nav-item"><a class="nav-link" href="./verification.html">交易日志</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <section class="card shadow-sm bg-body-tertiary border-secondary">
        <div class="card-header border-secondary d-flex justify-content-between align-items-center">
          <strong>基本信息编辑</strong>
          <a class="btn btn-sm btn-outline-light" href="./strategies.html">返回列表</a>
        </div>
        <div class="card-body">
          <form id="basicStrategyForm" class="row g-3">
            <div class="col-md-4">
              <label class="form-label" for="strategyId">策略 ID</label>
              <input id="strategyId" class="form-control" value="S-NEW" required />
            </div>
            <div class="col-md-4">
              <label class="form-label" for="secType">sec_type</label>
              <select id="secType" class="form-select">
                <option value="STK" selected>STK</option>
                <option value="FUT">FUT</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label" for="symbol">symbol</label>
              <input id="symbol" class="form-control" value="SLV" required />
            </div>
            <div class="col-md-6">
              <label class="form-label" for="strategyDescription">策略描述（自然语言）</label>
              <textarea id="strategyDescription" class="form-control" rows="2" required>新建策略，待设置触发条件与后续动作。</textarea>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="currency">currency</label>
              <input id="currency" class="form-control" value="USD" disabled />
            </div>
            <div class="col-md-3">
              <label class="form-label" for="upstreamOnly">激活限制</label>
              <select id="upstreamOnly" class="form-select">
                <option value="false" selected>允许手动激活</option>
                <option value="true">仅允许上游激活</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label" for="expireMode">过期方式</label>
              <select id="expireMode" class="form-select">
                <option value="relative" selected>相对时间</option>
                <option value="absolute">绝对时间</option>
              </select>
            </div>
            <div class="col-md-4" id="expireInGroup">
              <label class="form-label" for="expireInSeconds">expire_in_seconds（最长 604800）</label>
              <input id="expireInSeconds" type="number" class="form-control" min="1" max="604800" value="172800" />
            </div>
            <div class="col-md-4 d-none" id="expireAtGroup">
              <label class="form-label" for="expireAt">expire_at（本地时间）</label>
              <input id="expireAt" type="datetime-local" class="form-control" />
            </div>

            <div class="col-12 d-flex gap-2">
              <button type="submit" class="btn btn-primary">保存基本信息</button>
              <a class="btn btn-outline-secondary" href="./strategies.html">取消</a>
            </div>
          </form>
        </div>
      </section>
    </main>

    <script>
      const expireMode = document.getElementById("expireMode");
      const expireInGroup = document.getElementById("expireInGroup");
      const expireAtGroup = document.getElementById("expireAtGroup");
      const form = document.getElementById("basicStrategyForm");

      function syncExpireInputs() {
        const relative = expireMode.value === "relative";
        expireInGroup.classList.toggle("d-none", !relative);
        expireAtGroup.classList.toggle("d-none", relative);
      }

      expireMode.addEventListener("change", syncExpireInputs);
      syncExpireInputs();

      form.addEventListener("submit", (event) => {
        event.preventDefault();

        const params = new URLSearchParams();
        params.set("id", document.getElementById("strategyId").value.trim() || "S-NEW");
        params.set("draft", "1");
        params.set("conditions", "0");
        params.set("actions", "0");
        params.set("desc", document.getElementById("strategyDescription").value.trim());
        params.set("sec_type", document.getElementById("secType").value);
        params.set("symbol", document.getElementById("symbol").value.trim().toUpperCase());
        params.set("upstream_only_activation", document.getElementById("upstreamOnly").value);

        const mode = document.getElementById("expireMode").value;
        params.set("expire_mode", mode);
        if (mode === "relative") {
          params.set("expire_in_seconds", document.getElementById("expireInSeconds").value || "172800");
        } else {
          params.set("expire_at", document.getElementById("expireAt").value);
        }

        window.location.href = `./strategy-detail.html?${params.toString()}`;
      });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
