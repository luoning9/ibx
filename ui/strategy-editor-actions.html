<!doctype html>
<html lang="zh-CN" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IBX Console - 后续动作编辑</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg border-bottom sticky-top navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand fw-semibold" href="./index.html">IBX Console</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav" aria-controls="topNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="topNav">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="./strategies.html">策略列表</a></li>
            <li class="nav-item"><a class="nav-link" href="./events.html">运行事件</a></li>
            <li class="nav-item"><a class="nav-link" href="./positions.html">持仓情况</a></li>
            <li class="nav-item"><a class="nav-link" href="./trade-instructions.html">交易指令</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <section class="card shadow-sm bg-body-tertiary border-secondary">
        <div class="card-header border-secondary">
          <div class="row g-2 align-items-center">
            <div class="col-4">
              <strong>后续动作</strong>
            </div>
            <div class="col-4 text-center">
              <span class="small text-muted">后续动作状态：编辑中</span>
            </div>
            <div class="col-4 text-end">
              <a id="backToDetailFromActionsHeader" class="btn btn-sm btn-outline-light" href="./strategy-detail.html">返回策略详情</a>
            </div>
          </div>
        </div>
        <div class="card-body small">
          <div class="text-muted mb-3">策略ID：<span id="actionsEditorStrategyId">S-NEW</span></div>
          <div class="row g-3">
            <div class="col-lg-4">
              <div class="p-2 rounded border border-secondary-subtle bg-dark-subtle h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="text-muted">后续策略</div>
                  <span class="badge text-bg-secondary">NOT_SET</span>
                </div>
                <div class="mb-2">
                  <label class="form-label">策略ID</label>
                  <input class="form-control form-control-sm" placeholder="例如 S2（留空表示不激活后续策略）" />
                </div>
                <div class="mb-0">
                  <label class="form-label">说明</label>
                  <textarea class="form-control form-control-sm" rows="3" placeholder="例如：SLV 回撤达到 20% 时再卖出 100 股。"></textarea>
                </div>
              </div>
            </div>
            <div class="col-lg-8">
              <div class="p-2 rounded border border-secondary-subtle bg-dark-subtle h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="text-muted">交易指令</div>
                  <span class="badge text-bg-secondary">NOT_SET</span>
                </div>
                <div class="row g-2">
                  <div class="col-lg-7">
                    <label class="form-label">动作类型</label>
                    <div class="d-flex align-items-center gap-3 pt-1 flex-nowrap">
                      <div class="form-check form-check-inline mb-0">
                        <input class="form-check-input" type="radio" name="actionType" id="actionTypeStock" value="STOCK_TRADE" checked />
                        <label class="form-check-label text-nowrap" for="actionTypeStock">股票买卖</label>
                      </div>
                      <div class="form-check form-check-inline mb-0">
                        <input class="form-check-input" type="radio" name="actionType" id="actionTypeFutPosition" value="FUT_POSITION" />
                        <label class="form-check-label text-nowrap" for="actionTypeFutPosition">期货开平</label>
                      </div>
                      <div class="form-check form-check-inline mb-0">
                        <input class="form-check-input" type="radio" name="actionType" id="actionTypeFutRoll" value="FUT_ROLL" />
                        <label class="form-check-label text-nowrap" for="actionTypeFutRoll">期货展期</label>
                      </div>
                    </div>
                  </div>
                  <div class="col-lg-3">
                    <label class="form-label">产品代码</label>
                    <input class="form-control form-control-sm" id="actionSymbolInput" placeholder="例如 SLV / SI" />
                  </div>
                  <div class="col-lg-2">
                    <label class="form-label">当前持仓</label>
                    <div class="form-control form-control-sm bg-body-tertiary border-secondary-subtle text-muted" id="positionQtyDisplay">--</div>
                  </div>
                </div>

                <div class="row g-2 mt-1" id="normalTradeFields">
                  <div class="col-md-6 d-none" id="futContractGroup">
                    <label class="form-label">期货合约</label>
                    <input class="form-control form-control-sm" placeholder="例如 SIH7（可选）" />
                  </div>
                  <div class="col-md-6 d-none" id="positionEffectGroup">
                    <label class="form-label">开平类型</label>
                    <div class="btn-group w-100" role="group" aria-label="position effect">
                      <input type="radio" class="btn-check" name="positionEffect" id="positionOpen" value="OPEN" checked />
                      <label class="btn btn-sm btn-outline-light" for="positionOpen">OPEN</label>

                      <input type="radio" class="btn-check" name="positionEffect" id="positionClose" value="CLOSE" />
                      <label class="btn btn-sm btn-outline-light" for="positionClose">CLOSE</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">方向</label>
                    <div class="btn-group w-100" role="group" aria-label="trade side">
                      <input type="radio" class="btn-check" name="tradeSide" id="tradeSideBuy" value="BUY" checked />
                      <label class="btn btn-sm btn-outline-light" for="tradeSideBuy">BUY</label>

                      <input type="radio" class="btn-check" name="tradeSide" id="tradeSideSell" value="SELL" />
                      <label class="btn btn-sm btn-outline-light" for="tradeSideSell">SELL</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">下单数量</label>
                    <input class="form-control form-control-sm" id="tradeQuantityInput" placeholder="100" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">订单类型</label>
                    <div class="btn-group w-100" role="group" aria-label="order type">
                      <input type="radio" class="btn-check" name="orderType" id="orderTypeLmt" value="LMT" checked />
                      <label class="btn btn-sm btn-outline-light" for="orderTypeLmt">LMT</label>

                      <input type="radio" class="btn-check" name="orderType" id="orderTypeMkt" value="MKT" />
                      <label class="btn btn-sm btn-outline-light" for="orderTypeMkt">MKT</label>
                    </div>
                  </div>

                  <div class="col-md-6" id="limitPriceGroup">
                    <label class="form-label">限价（LMT）</label>
                    <input class="form-control form-control-sm" id="limitPriceInput" placeholder="仅限价单必填" />
                  </div>
                  <div class="col-md-6 d-none" id="marketHintGroup">
                    <label class="form-label">限价（LMT）</label>
                    <div class="form-control form-control-sm bg-body-tertiary border-secondary-subtle text-muted">
                      市价单（MKT）将按当时市场价格撮合。
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label d-block">隔夜交易</label>
                    <div class="form-check mt-1">
                      <input class="form-check-input" type="checkbox" id="allowOvernightTrade" />
                      <label class="form-check-label" for="allowOvernightTrade">允许隔夜时段成交（可选）</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">到期撤单</label>
                    <select class="form-select form-select-sm" id="cancelOnExpiryTrade">
                      <option value="false" selected>false（继续跟踪成交）</option>
                      <option value="true">true（到期尝试撤单）</option>
                    </select>
                  </div>
                  <div class="col-12" id="stockSummaryGroup">
                    <div class="p-2 rounded border border-secondary-subtle bg-body-tertiary">
                      <div class="text-muted small mb-1">交易摘要</div>
                      <div class="small" id="stockSummaryText">买入 100 股 SLV，LMT，限价 --，DAY，隔夜=否，到期撤单=false</div>
                    </div>
                  </div>
                </div>

                <div class="row g-2 mt-1 d-none" id="rollTradeFields">
                  <div class="col-12">
                    <div class="small text-muted">展期执行：先平待切换合约，再开目标合约。</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label">待平合约（近月）</label>
                    <input class="form-control form-control-sm" placeholder="例如 SIH6" />
                  </div>
                  <div class="col-6">
                    <label class="form-label">目标合约（远月）</label>
                    <input class="form-control form-control-sm" placeholder="例如 SIK6" />
                  </div>
                  <div class="col-6">
                    <label class="form-label">展期数量</label>
                    <input class="form-control form-control-sm" placeholder="例如 2" />
                  </div>
                  <div class="col-6">
                    <label class="form-label">平仓订单类型</label>
                    <select class="form-select form-select-sm" id="rollCloseOrderTypeSelect">
                      <option value="LMT" selected>LMT</option>
                      <option value="MKT">MKT</option>
                    </select>
                  </div>
                  <div class="col-6" id="rollCloseLimitPriceGroup">
                    <label class="form-label">平仓限价</label>
                    <input class="form-control form-control-sm" placeholder="仅平仓 LMT 必填" />
                  </div>
                  <div class="col-6">
                    <label class="form-label">开仓订单类型</label>
                    <select class="form-select form-select-sm" id="rollOpenOrderTypeSelect">
                      <option value="LMT" selected>LMT</option>
                      <option value="MKT">MKT</option>
                    </select>
                  </div>
                  <div class="col-6">
                    <label class="form-label d-block">隔夜交易</label>
                    <div class="form-check mt-1">
                      <input class="form-check-input" type="checkbox" id="allowOvernightRoll" />
                      <label class="form-check-label" for="allowOvernightRoll">允许隔夜时段成交（可选）</label>
                    </div>
                  </div>
                  <div class="col-6" id="rollOpenLimitPriceGroup">
                    <label class="form-label">开仓限价</label>
                    <input class="form-control form-control-sm" placeholder="仅开仓 LMT 必填" />
                  </div>
                  <div class="col-6">
                    <label class="form-label">腿间最大滑点</label>
                    <div class="input-group input-group-sm">
                      <input class="form-control" placeholder="例如 0.25" />
                      <span class="input-group-text">USD</span>
                    </div>
                  </div>
                  <div class="col-6">
                    <label class="form-label">到期撤单</label>
                    <select class="form-select form-select-sm">
                      <option value="false" selected>false（继续跟踪成交）</option>
                      <option value="true">true（到期尝试撤单）</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4 d-flex gap-2">
            <button id="saveActionsBtn" class="btn btn-primary">保存后续动作</button>
            <a id="backToDetailFromActions" class="btn btn-outline-secondary" href="./strategy-detail.html">取消</a>
          </div>
        </div>
      </section>
    </main>

    <script>
      const params = new URLSearchParams(window.location.search);
      const strategyId = params.get("id") || "S-NEW";
      const secType = (params.get("sec_type") || "STK").toUpperCase();
      const symbol = (params.get("symbol") || "").toUpperCase();

      document.getElementById("actionsEditorStrategyId").textContent = strategyId;
      if (symbol) {
        const actionSymbolInput = document.getElementById("actionSymbolInput");
        actionSymbolInput.value = symbol;
      }

      function detailHref(actionsConfigured) {
        const next = new URLSearchParams(params);
        next.set("id", strategyId);
        if (!next.has("draft")) next.set("draft", "1");
        if (!next.has("conditions")) next.set("conditions", "0");
        next.set("actions", actionsConfigured ? "1" : next.get("actions") || "0");
        return `./strategy-detail.html?${next.toString()}`;
      }

      const cancelHref = detailHref(false);
      document.getElementById("backToDetailFromActionsHeader").href = cancelHref;
      document.getElementById("backToDetailFromActions").href = cancelHref;

      document.getElementById("saveActionsBtn").addEventListener("click", () => {
        window.location.href = detailHref(true);
      });

      const orderTypeRadios = document.querySelectorAll('input[name="orderType"]');
      const tradeSideRadios = document.querySelectorAll('input[name="tradeSide"]');
      const limitPriceGroup = document.getElementById("limitPriceGroup");
      const marketHintGroup = document.getElementById("marketHintGroup");
      const limitPriceInput = document.getElementById("limitPriceInput");
      const tradeQuantityInput = document.getElementById("tradeQuantityInput");
      const actionSymbolInput = document.getElementById("actionSymbolInput");
      const positionQtyDisplay = document.getElementById("positionQtyDisplay");
      const allowOvernightTrade = document.getElementById("allowOvernightTrade");
      const cancelOnExpiryTrade = document.getElementById("cancelOnExpiryTrade");
      const stockSummaryGroup = document.getElementById("stockSummaryGroup");
      const stockSummaryText = document.getElementById("stockSummaryText");
      const actionTypeRadios = document.querySelectorAll('input[name="actionType"]');
      const normalTradeFields = document.getElementById("normalTradeFields");
      const rollTradeFields = document.getElementById("rollTradeFields");
      const futContractGroup = document.getElementById("futContractGroup");
      const positionEffectGroup = document.getElementById("positionEffectGroup");
      const rollCloseOrderTypeSelect = document.getElementById("rollCloseOrderTypeSelect");
      const rollOpenOrderTypeSelect = document.getElementById("rollOpenOrderTypeSelect");
      const rollCloseLimitPriceGroup = document.getElementById("rollCloseLimitPriceGroup");
      const rollOpenLimitPriceGroup = document.getElementById("rollOpenLimitPriceGroup");

      function syncLimitPriceVisibility() {
        const selectedOrderType = document.querySelector('input[name="orderType"]:checked')?.value || "LMT";
        const isLimitOrder = selectedOrderType === "LMT";
        limitPriceGroup.classList.toggle("d-none", !isLimitOrder);
        marketHintGroup.classList.toggle("d-none", isLimitOrder);
      }

      function updateStockSummary() {
        const selectedActionType = document.querySelector('input[name="actionType"]:checked')?.value || "STOCK_TRADE";
        if (selectedActionType !== "STOCK_TRADE") return;
        const symbolText = (actionSymbolInput.value || "--").toUpperCase();
        const side = document.querySelector('input[name="tradeSide"]:checked')?.value || "BUY";
        const sideText = side === "BUY" ? "买入" : "卖出";
        const qtyText = tradeQuantityInput.value.trim() || "--";
        const orderType = document.querySelector('input[name="orderType"]:checked')?.value || "LMT";
        const overnightText = allowOvernightTrade.checked ? "是" : "否";
        const cancelText = cancelOnExpiryTrade.value;
        const limitText = orderType === "LMT" ? `，限价 ${limitPriceInput.value.trim() || "--"}` : "";
        stockSummaryText.textContent = `${sideText} ${qtyText} 股 ${symbolText}，${orderType}${limitText}，DAY，隔夜=${overnightText}，到期撤单=${cancelText}`;
      }

      function updatePositionHint() {
        const symbolText = (actionSymbolInput.value || "").trim().toUpperCase();
        if (!symbolText) {
          positionQtyDisplay.textContent = "--";
          return;
        }
        // Prototype data; replace with real position query from backend API.
        const stockPositions = { SLV: 320, SPY: 85, QQQ: 40, AAPL: 60 };
        const futPositions = { SI: 3, ES: 1, NQ: 2, CL: 0 };
        if (secType === "FUT") {
          const qty = futPositions[symbolText];
          positionQtyDisplay.textContent = qty !== undefined ? `${qty} 手` : "0 手";
          return;
        }
        const qty = stockPositions[symbolText];
        positionQtyDisplay.textContent = qty !== undefined ? `${qty} 股` : "0 股";
      }

      function syncRollLimitPriceVisibility() {
        rollCloseLimitPriceGroup.classList.toggle("d-none", rollCloseOrderTypeSelect.value !== "LMT");
        rollOpenLimitPriceGroup.classList.toggle("d-none", rollOpenOrderTypeSelect.value !== "LMT");
      }

      function syncActionType() {
        const selectedActionType = document.querySelector('input[name="actionType"]:checked')?.value || "STOCK_TRADE";
        const isRoll = selectedActionType === "FUT_ROLL";
        const isFutPosition = selectedActionType === "FUT_POSITION";
        const isStock = selectedActionType === "STOCK_TRADE";
        normalTradeFields.classList.toggle("d-none", isRoll);
        rollTradeFields.classList.toggle("d-none", !isRoll);
        futContractGroup.classList.toggle("d-none", !isFutPosition);
        positionEffectGroup.classList.toggle("d-none", !isFutPosition);
        stockSummaryGroup.classList.toggle("d-none", !isStock);
      }

      if (secType !== "FUT") {
        document.getElementById("actionTypeStock").checked = true;
        document.getElementById("actionTypeFutPosition").disabled = true;
        document.getElementById("actionTypeFutRoll").disabled = true;
      } else {
        document.getElementById("actionTypeStock").disabled = true;
        document.getElementById("actionTypeFutPosition").checked = true;
      }

      if (secType === "FUT" && symbol) {
        const titleLine = document.querySelector("main .text-muted.mb-3");
        titleLine.insertAdjacentHTML("beforeend", ` <span class="ms-2">产品：<code>${symbol}</code>（FUT）</span>`);
      }

      actionTypeRadios.forEach((radio) => radio.addEventListener("change", syncActionType));
      rollCloseOrderTypeSelect.addEventListener("change", syncRollLimitPriceVisibility);
      rollOpenOrderTypeSelect.addEventListener("change", syncRollLimitPriceVisibility);
      orderTypeRadios.forEach((radio) => radio.addEventListener("change", () => {
        syncLimitPriceVisibility();
        updateStockSummary();
      }));
      tradeSideRadios.forEach((radio) => radio.addEventListener("change", updateStockSummary));
      tradeQuantityInput.addEventListener("input", updateStockSummary);
      limitPriceInput.addEventListener("input", updateStockSummary);
      actionSymbolInput.addEventListener("input", () => {
        updateStockSummary();
        updatePositionHint();
      });
      allowOvernightTrade.addEventListener("change", updateStockSummary);
      cancelOnExpiryTrade.addEventListener("change", updateStockSummary);
      syncActionType();
      syncRollLimitPriceVisibility();
      syncLimitPriceVisibility();
      updateStockSummary();
      updatePositionHint();
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
